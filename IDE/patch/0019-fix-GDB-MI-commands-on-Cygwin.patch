From 4db7c878603d2e135d24e150582c7c12413b93d3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E5=BE=90=E6=8C=81=E6=81=92=20Xu=20Chiheng?=
 <chiheng.xu@gmail.com>
Date: Wed, 10 Apr 2024 04:18:03 +0800
Subject: [PATCH 19/21] fix GDB MI commands on Cygwin

---
 .../gdb/service/GdbDebugServicesFactory.java  | 49 ++++++++++++++
 .../command/CommandFactory_Cygwin.java        | 64 +++++++++++++++++++
 .../eclipse/cdt/dsf/mi/service/MIStack.java   | 14 +++-
 .../commands/cygwin/CygwinMIBreakInsert.java  | 46 +++++++++++++
 .../cygwin/CygwinMIEnvironmentCD.java         | 20 ++++++
 .../cygwin/CygwinMIEnvironmentDirectory.java  | 30 +++++++++
 .../cygwin/CygwinMIFileExecAndSymbols.java    | 24 +++++++
 7 files changed, 245 insertions(+), 2 deletions(-)
 create mode 100644 dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/command/CommandFactory_Cygwin.java
 create mode 100644 dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIBreakInsert.java
 create mode 100644 dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentCD.java
 create mode 100644 dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentDirectory.java
 create mode 100644 dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIFileExecAndSymbols.java

diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/GdbDebugServicesFactory.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/GdbDebugServicesFactory.java
index 20072bceb2..7eba1d1838 100644
--- a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/GdbDebugServicesFactory.java
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/GdbDebugServicesFactory.java
@@ -26,7 +26,11 @@
  *******************************************************************************/
 package org.eclipse.cdt.dsf.gdb.service;
 
+import java.util.Map;
+import java.util.TreeMap;
+
 import org.eclipse.cdt.debug.core.CDebugCorePlugin;
+import org.eclipse.cdt.debug.core.ICDTLaunchConfigurationConstants;
 import org.eclipse.cdt.dsf.debug.service.AbstractDsfDebugServicesFactory;
 import org.eclipse.cdt.dsf.debug.service.IBreakpoints;
 import org.eclipse.cdt.dsf.debug.service.IDisassembly;
@@ -46,6 +50,7 @@ import org.eclipse.cdt.dsf.gdb.internal.service.IGDBFocusSynchronizer;
 import org.eclipse.cdt.dsf.gdb.launching.GdbLaunch;
 import org.eclipse.cdt.dsf.gdb.launching.LaunchUtils;
 import org.eclipse.cdt.dsf.gdb.service.command.CommandFactory_6_8;
+import org.eclipse.cdt.dsf.gdb.service.command.CommandFactory_Cygwin;
 import org.eclipse.cdt.dsf.gdb.service.command.GDBControl;
 import org.eclipse.cdt.dsf.gdb.service.command.GDBControl_7_0;
 import org.eclipse.cdt.dsf.gdb.service.command.GDBControl_7_12;
@@ -64,8 +69,13 @@ import org.eclipse.cdt.dsf.mi.service.MIStack;
 import org.eclipse.cdt.dsf.mi.service.command.CommandFactory;
 import org.eclipse.cdt.dsf.service.DsfSession;
 import org.eclipse.cdt.dsf.service.IDsfService;
+import org.eclipse.cdt.internal.core.Cygwin;
+import org.eclipse.cdt.utils.spawner.ProcessFactory;
+import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.IStatus;
+import org.eclipse.core.runtime.Platform;
 import org.eclipse.core.runtime.Status;
+import org.eclipse.debug.core.DebugPlugin;
 import org.eclipse.debug.core.ILaunch;
 import org.eclipse.debug.core.ILaunchConfiguration;
 import org.eclipse.osgi.util.NLS;
@@ -215,7 +225,46 @@ public class GdbDebugServicesFactory extends AbstractDsfDebugServicesFactory {
 		return new MIBreakpoints(session);
 	}
 
+	private static boolean isCygwin(ILaunchConfiguration config) {
+		if (Platform.getOS().equals(Platform.OS_WIN32)) {
+			String[] envp = null;
+			try {
+				envp = DebugPlugin.getDefault().getLaunchManager().getEnvironment(config);
+			} catch (CoreException e) {
+				// TODO Auto-generated catch block
+				e.printStackTrace();
+			}
+
+			TreeMap<String, String> envMap = ProcessFactory.envpToEnvMap(envp);
+			if (envMap.containsKey(Cygwin.ENV_CYGWIN_HOME)) {
+				return true;
+			}
+		}
+		if (Platform.getOS().equals(Platform.OS_WIN32)) {
+			Map<String, Object> attrs = null;
+			try {
+				attrs = config.getAttributes();
+			} catch (CoreException e) {
+				// TODO Auto-generated catch block
+				e.printStackTrace();
+			}
+			String key = ICDTLaunchConfigurationConstants.ATTR_PROJECT_BUILD_CONFIG_ID;
+			if (attrs != null && attrs.containsKey(key)) {
+				Object value = attrs.get(key);
+				String valueString = value.toString();
+				if (valueString.startsWith("cdt.managedbuild.config.gnu.cygwin.")) { //$NON-NLS-1$
+					return true;
+				}
+			}
+		}
+		return false;
+	}
+
 	protected ICommandControl createCommandControl(DsfSession session, ILaunchConfiguration config) {
+		if (isCygwin(config)) {
+			return new GDBControl_7_12(session, config, new CommandFactory_Cygwin());
+		}
+
 		if (compareVersionWith(GDB_7_12_VERSION) >= 0) {
 			return new GDBControl_7_12(session, config, new CommandFactory_6_8());
 		}
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/command/CommandFactory_Cygwin.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/command/CommandFactory_Cygwin.java
new file mode 100644
index 0000000000..a691a3b5cb
--- /dev/null
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/gdb/service/command/CommandFactory_Cygwin.java
@@ -0,0 +1,64 @@
+/********************************************************************************
+ * Copyright (c) 2024 徐持恒 Xu Chiheng
+ *
+ * This program and the accompanying materials are made available under the
+ * terms of the Eclipse Public License 2.0 which is available at
+ * http://www.eclipse.org/legal/epl-2.0.
+ *
+ * SPDX-License-Identifier: EPL-2.0
+ ********************************************************************************/
+package org.eclipse.cdt.dsf.gdb.service.command;
+
+import org.eclipse.cdt.dsf.datamodel.IDMContext;
+import org.eclipse.cdt.dsf.debug.service.IBreakpoints.IBreakpointsTargetDMContext;
+import org.eclipse.cdt.dsf.debug.service.command.ICommand;
+import org.eclipse.cdt.dsf.debug.service.command.ICommandControlService.ICommandControlDMContext;
+import org.eclipse.cdt.dsf.mi.service.IMIContainerDMContext;
+import org.eclipse.cdt.dsf.mi.service.command.commands.cygwin.CygwinMIBreakInsert;
+import org.eclipse.cdt.dsf.mi.service.command.commands.cygwin.CygwinMIEnvironmentCD;
+import org.eclipse.cdt.dsf.mi.service.command.commands.cygwin.CygwinMIEnvironmentDirectory;
+import org.eclipse.cdt.dsf.mi.service.command.commands.cygwin.CygwinMIFileExecAndSymbols;
+import org.eclipse.cdt.dsf.mi.service.command.output.MIBreakInsertInfo;
+import org.eclipse.cdt.dsf.mi.service.command.output.MIInfo;
+
+public class CommandFactory_Cygwin extends CommandFactory_6_8 {
+
+	@Override
+	public ICommand<MIInfo> createMIEnvironmentCD(ICommandControlDMContext ctx, String path) {
+		return new CygwinMIEnvironmentCD(ctx, path);
+	}
+
+	@Override
+	public ICommand<MIInfo> createMIEnvironmentDirectory(IDMContext ctx, String[] paths, boolean reset) {
+		return new CygwinMIEnvironmentDirectory(ctx, paths, reset);
+	}
+
+	@Override
+	public ICommand<MIInfo> createMIFileExecAndSymbols(IMIContainerDMContext dmc, String file) {
+		return new CygwinMIFileExecAndSymbols(dmc, file);
+	}
+
+	@Override
+	public ICommand<MIInfo> createMIFileExecAndSymbols(IMIContainerDMContext dmc) {
+		return new CygwinMIFileExecAndSymbols(dmc);
+	}
+
+	@Override
+	public ICommand<MIBreakInsertInfo> createMIBreakInsert(IBreakpointsTargetDMContext ctx, String func) {
+		return new CygwinMIBreakInsert(ctx, func, false);
+	}
+
+	@Override
+	public ICommand<MIBreakInsertInfo> createMIBreakInsert(IBreakpointsTargetDMContext ctx, boolean isTemporary,
+			boolean isHardware, String condition, int ignoreCount, String line, String tid) {
+		return new CygwinMIBreakInsert(ctx, isTemporary, isHardware, condition, ignoreCount, line, tid, false);
+	}
+
+	@Override
+	public ICommand<MIBreakInsertInfo> createMIBreakInsert(IBreakpointsTargetDMContext ctx, boolean isTemporary,
+			boolean isHardware, String condition, int ignoreCount, String location, String tid, boolean disabled,
+			boolean isTracepoint) {
+		return new CygwinMIBreakInsert(ctx, isTemporary, isHardware, condition, ignoreCount, location, tid, disabled,
+				isTracepoint, false);
+	}
+}
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/MIStack.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/MIStack.java
index ae8580abde..17350d0034 100644
--- a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/MIStack.java
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/MIStack.java
@@ -24,6 +24,7 @@ import java.util.LinkedHashMap;
 import java.util.List;
 import java.util.Map;
 
+import org.eclipse.cdt.core.Cygwin;
 import org.eclipse.cdt.core.IAddress;
 import org.eclipse.cdt.dsf.concurrent.CountingRequestMonitor;
 import org.eclipse.cdt.dsf.concurrent.DataRequestMonitor;
@@ -64,6 +65,7 @@ import org.eclipse.cdt.dsf.service.DsfSession;
 import org.eclipse.cdt.utils.Addr32;
 import org.eclipse.cdt.utils.Addr64;
 import org.eclipse.core.runtime.IStatus;
+import org.eclipse.core.runtime.Platform;
 import org.eclipse.core.runtime.Status;
 import org.osgi.framework.BundleContext;
 
@@ -384,7 +386,15 @@ public class MIStack extends AbstractDsfService implements IStack, ICachingServi
 
 		@Override
 		public String getFile() {
-			return getMIFrame().getFile();
+			//translate debugger path to host source path
+			String debuggerPath = getMIFrame().getFile();
+			String sourcePath = debuggerPath;
+			if (Platform.getOS().equals(Platform.OS_WIN32)) {
+				if (debuggerPath.startsWith("/")) { //$NON-NLS-1$
+					sourcePath = Cygwin.pathToWindows(debuggerPath);
+				}
+			}
+			return sourcePath;
 		}
 
 		@Override
@@ -470,7 +480,7 @@ public class MIStack extends AbstractDsfService implements IStack, ICachingServi
 		fCommandFactory = getServicesTracker().getService(IMICommandControl.class).getCommandFactory();
 
 		getSession().addServiceEventListener(this, null);
-		register(new String[] { IStack.class.getName(), MIStack.class.getName() }, new Hashtable<String, String>());
+		register(new String[] { IStack.class.getName(), MIStack.class.getName() }, new Hashtable<>());
 		rm.done();
 	}
 
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIBreakInsert.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIBreakInsert.java
new file mode 100644
index 0000000000..b3a1278811
--- /dev/null
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIBreakInsert.java
@@ -0,0 +1,46 @@
+/********************************************************************************
+ * Copyright (c) 2024 徐持恒 Xu Chiheng
+ *
+ * This program and the accompanying materials are made available under the
+ * terms of the Eclipse Public License 2.0 which is available at
+ * http://www.eclipse.org/legal/epl-2.0.
+ *
+ * SPDX-License-Identifier: EPL-2.0
+ ********************************************************************************/
+
+package org.eclipse.cdt.dsf.mi.service.command.commands.cygwin;
+
+import org.eclipse.cdt.core.Cygwin;
+import org.eclipse.cdt.dsf.debug.service.IBreakpoints.IBreakpointsTargetDMContext;
+import org.eclipse.cdt.dsf.mi.service.command.commands.MIBreakInsert;
+
+public class CygwinMIBreakInsert extends MIBreakInsert {
+
+	public CygwinMIBreakInsert(IBreakpointsTargetDMContext ctx, String func, boolean allowPending) {
+		this(ctx, false, false, null, 0, func, "0", allowPending); //$NON-NLS-1$
+	}
+
+	public CygwinMIBreakInsert(IBreakpointsTargetDMContext ctx, boolean isTemporary, boolean isHardware,
+			String condition, int ignoreCount, String line, String tid, boolean allowPending) {
+		this(ctx, isTemporary, isHardware, condition, ignoreCount, line, tid, false, false, allowPending);
+	}
+
+	public CygwinMIBreakInsert(IBreakpointsTargetDMContext ctx, boolean isTemporary, boolean isHardware,
+			String condition, int ignoreCount, String location, String tid, boolean disabled, boolean isTracepoint,
+			boolean allowPending) {
+		super(ctx, isTemporary, isHardware, condition, ignoreCount, convertLocation(location), tid, disabled,
+				isTracepoint, allowPending);
+	}
+
+	private static String convertLocation(String location) {
+		String newLocation = location;
+		if (location.matches("[a-zA-Z]:/.*:.*")) { //$NON-NLS-1$
+			int columIndex = location.lastIndexOf(':');
+			String fileName = location.substring(0, columIndex);
+			fileName = Cygwin.pathToUnix(fileName);
+			String functionOrLineNumber = location.substring(columIndex + 1);
+			newLocation = fileName + ':' + functionOrLineNumber;
+		}
+		return newLocation;
+	}
+}
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentCD.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentCD.java
new file mode 100644
index 0000000000..48d234a30f
--- /dev/null
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentCD.java
@@ -0,0 +1,20 @@
+/********************************************************************************
+ * Copyright (c) 2024 徐持恒 Xu Chiheng
+ *
+ * This program and the accompanying materials are made available under the
+ * terms of the Eclipse Public License 2.0 which is available at
+ * http://www.eclipse.org/legal/epl-2.0.
+ *
+ * SPDX-License-Identifier: EPL-2.0
+ ********************************************************************************/
+package org.eclipse.cdt.dsf.mi.service.command.commands.cygwin;
+
+import org.eclipse.cdt.core.Cygwin;
+import org.eclipse.cdt.dsf.debug.service.command.ICommandControlService.ICommandControlDMContext;
+import org.eclipse.cdt.dsf.mi.service.command.commands.MIEnvironmentCD;
+
+public class CygwinMIEnvironmentCD extends MIEnvironmentCD {
+	public CygwinMIEnvironmentCD(ICommandControlDMContext ctx, String path) {
+		super(ctx, Cygwin.pathToUnix(path));
+	}
+}
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentDirectory.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentDirectory.java
new file mode 100644
index 0000000000..c37321f1bc
--- /dev/null
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIEnvironmentDirectory.java
@@ -0,0 +1,30 @@
+/********************************************************************************
+ * Copyright (c) 2024 徐持恒 Xu Chiheng
+ *
+ * This program and the accompanying materials are made available under the
+ * terms of the Eclipse Public License 2.0 which is available at
+ * http://www.eclipse.org/legal/epl-2.0.
+ *
+ * SPDX-License-Identifier: EPL-2.0
+ ********************************************************************************/
+package org.eclipse.cdt.dsf.mi.service.command.commands.cygwin;
+
+import org.eclipse.cdt.core.Cygwin;
+import org.eclipse.cdt.dsf.datamodel.IDMContext;
+import org.eclipse.cdt.dsf.mi.service.command.commands.MIEnvironmentDirectory;
+
+public class CygwinMIEnvironmentDirectory extends MIEnvironmentDirectory {
+	public CygwinMIEnvironmentDirectory(IDMContext ctx, String[] paths, boolean reset) {
+		super(ctx, convertPaths(paths), reset);
+	}
+
+	private static String[] convertPaths(String[] paths) {
+		String[] newPaths = new String[paths.length];
+		for (int i = 0; i < paths.length; i++) {
+			String path = paths[i];
+			String newPath = Cygwin.pathToUnix(path);
+			newPaths[i] = newPath;
+		}
+		return newPaths;
+	}
+}
diff --git a/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIFileExecAndSymbols.java b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIFileExecAndSymbols.java
new file mode 100644
index 0000000000..627294872d
--- /dev/null
+++ b/dsf-gdb/org.eclipse.cdt.dsf.gdb/src/org/eclipse/cdt/dsf/mi/service/command/commands/cygwin/CygwinMIFileExecAndSymbols.java
@@ -0,0 +1,24 @@
+/********************************************************************************
+ * Copyright (c) 2024 徐持恒 Xu Chiheng
+ *
+ * This program and the accompanying materials are made available under the
+ * terms of the Eclipse Public License 2.0 which is available at
+ * http://www.eclipse.org/legal/epl-2.0.
+ *
+ * SPDX-License-Identifier: EPL-2.0
+ ********************************************************************************/
+package org.eclipse.cdt.dsf.mi.service.command.commands.cygwin;
+
+import org.eclipse.cdt.core.Cygwin;
+import org.eclipse.cdt.dsf.mi.service.IMIContainerDMContext;
+import org.eclipse.cdt.dsf.mi.service.command.commands.MIFileExecAndSymbols;
+
+public class CygwinMIFileExecAndSymbols extends MIFileExecAndSymbols {
+	public CygwinMIFileExecAndSymbols(IMIContainerDMContext dmc) {
+		this(dmc, null);
+	}
+
+	public CygwinMIFileExecAndSymbols(IMIContainerDMContext dmc, String file) {
+		super(dmc, Cygwin.pathToUnix(file));
+	}
+}
-- 
2.42.1

